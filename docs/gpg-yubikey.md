# gpg + yubikey setup

## overview

this setup uses a yubikey as a hardware security key to store gpg private keys. ssh authentication is handled through gpg-agent, so there's no separate ssh key - the gpg authentication subkey IS the ssh key.

```
┌─────────────────────────────────────────────────────────────┐
│                        yubikey                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │ signing key │ │ encrypt key │ │ authentication key  │   │
│  │    [S]      │ │    [E]      │ │   [A] → ssh key     │   │
│  └─────────────┘ └─────────────┘ └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │  gpg-agent  │
                    │ (ssh mode)  │
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              ▼                         ▼
       gpg operations             ssh connections
       (sign, decrypt)            (via [A] subkey)
```

## key structure

| key type           | purpose                | location       | symbol |
| ------------------ | ---------------------- | -------------- | ------ |
| master key [C]     | certify/create subkeys | offline backup | `sec#` |
| signing [S]        | sign commits, messages | yubikey        | `ssb>` |
| encryption [E]     | decrypt messages       | yubikey        | `ssb>` |
| authentication [A] | ssh auth               | yubikey        | `ssb>` |

- `#` = private key not present (stored offline)
- `>` = private key on smartcard (yubikey)

## what's stored where

### on yubikey (private keys)

- signing subkey
- encryption subkey
- authentication subkey (used for ssh)

### offline backup

- `gpg public key` - needed to set up new machines
- `ssh-gpg public key` - same as above, just ssh format
- `gpg-master-key.asc/.gpg` - encrypted master key backup, only needed for:
  - yubikey dies/lost → provision new yubikey with same identity
  - subkeys expire → extend expiry dates
  - add new subkey → e.g., add a second authentication key
  - revoke keys → if compromised

### on each machine (gpg keyring)

- public key (imported)
- stubs pointing to yubikey (created by `gpg --card-status`)

## how it works

1. gpg-agent runs with ssh support enabled
2. when ssh needs a key, it asks gpg-agent
3. gpg-agent sees the key is on a card, prompts for yubikey pin
4. yubikey performs the cryptographic operation
5. ssh connection established

## new machine setup

### clan-managed machines

1. **generate vars** (first time only, shared across all machines)

   ```bash
   clan vars generate <machine>
   # when prompted for gpg public key, paste it and press ctrl+d
   ```

2. **deploy machine**

   ```bash
   clan machines update <machine>
   # public key is auto-imported via home-manager
   ```

3. **link to yubikey** (needs yubikey plugged in)

   ```bash
   gpg --card-status
   ```

4. **verify**
   ```bash
   gpg -K  # should show ssb> for subkeys
   ssh-add -L  # should show your ssh key
   ```

### non-clan machines

1. **import public key**

   ```bash
   gpg --import pubkey.asc
   ```

2. **link to yubikey**
   ```bash
   gpg --card-status
   ```

the nixos config handles gpg-agent, pcscd, udev rules, etc.

## recovery scenarios

### lost/broken yubikey

1. get new yubikey
2. decrypt `gpg-master-key.asc` with your passphrase
3. import master key to air-gapped machine
4. transfer subkeys to new yubikey (gpg --edit-key → keytocard)
5. follow "new machine setup" on all machines

### new machine (yubikey working)

just follow "new machine setup" above - only need public key

### expired subkeys

1. decrypt master key backup
2. import on air-gapped machine
3. extend expiry or create new subkeys
4. export new public key
5. re-import public key on all machines

## nixos config locations

| file                              | purpose                                        |
| --------------------------------- | ---------------------------------------------- |
| `modules/yubikey/`                | system-level yubikey support                   |
| `modules/yubikey/gpg-ssh.nix`     | gpg-agent as ssh agent, vars generator         |
| `users/simon/system/gpg.nix`      | gpg settings, gpg-agent config                 |
| `vars/shared/yubikey-gpg-pubkey/` | shared gpg public key (generated by clan vars) |

## useful commands

```bash
gpg --card-status          # check yubikey connection
gpg -K                     # list secret keys (shows # and > symbols)
gpg --export-ssh-key <keyid>  # get ssh public key from gpg
ssh-add -L                 # list ssh keys (via gpg-agent)
```

## troubleshooting

**ssh not working after reboot**

```bash
gpg --card-status  # re-establishes connection to yubikey
```

**"no secret key" errors**

- check yubikey is plugged in
- run `gpg --card-status`
- verify with `gpg -K` (should show `>` not `#` for subkeys)

**pinentry not appearing**

- check `GPG_TTY` is set (should be automatic via config)
- try `gpg --card-status` in terminal first
