# nixinfra

infrastructure as code using NixOS flakes for lxc containers, vms, and bare-metal servers.

## features

- **auto-discovery hosts system**: automatically scans `hosts/` directory and generates nixosConfigurations
- **convention over configuration**: minimal boilerplate, intelligent defaults
- **secrets management**: agenix-rekey for encrypted secrets with automatic rekeying
- **dry principles**: single source of truth for users, shares, and secrets
- **type-based organization**: hosts organized by type (lxc, vms, bare-metal)

## quick start

```bash
# enter development shell
nix develop

# check configuration
nix flake check

# build a specific host
nix build .#nixosConfigurations.fileserver-lxc.config.system.build.toplevel

# update flake inputs
nix flake update

# rekey secrets after changes
agenix rekey -a
```

## auto-discovery hosts system

the flake automatically discovers all hosts from the directory structure in `hosts/`. no manual flake.nix editing required when adding new hosts.

### how it works

1. scans `hosts/{lxc,bare-metal,vms}/` directories recursively
2. identifies host directories (those containing `default.nix`)
3. auto-generates nixosConfigurations with naming: `{hostname}-{type}`
4. auto-sets `networking.hostName` (can be overridden with explicit value)

example: `hosts/lxc/fileserver/default.nix` becomes `fileserver-lxc`

### adding a new host

```bash
# create host directory
mkdir -p hosts/lxc/mynewhost

# create configuration
cat > hosts/lxc/mynewhost/default.nix <<'EOF'
{ mylib, ... }:
{
  imports = [
    ../../../modules/shared
    ../../../modules/lxc
  ] ++ (mylib.scanPaths ./. { exclude = [ ]; });

  nixpkgs.hostPlatform = "x86_64-linux";
  system.stateVersion = "25.05";
}
EOF

# that's it! the host is automatically available as mynewhost-lxc
nix flake check
```

### host types

- **lxc**: proxmox lxc containers (lightweight, shared kernel)
- **bare-metal**: physical servers
- **vms**: virtual machines (full kernel, more isolated)

## directory structure

```
nixinfra/
├── flake.nix              # main flake configuration
├── hosts/
│   ├── default.nix        # auto-discovery logic
│   ├── lxc/              # lxc containers
│   │   ├── fileserver/   # samba fileserver
│   │   ├── newt/         # host newt
│   │   ├── pangolin/     # host pangolin
│   │   └── tailscale/    # tailscale relay
│   ├── bare-metal/       # physical servers
│   │   ├── home-server/
│   │   └── proxmox/
│   └── vms/              # virtual machines
│       └── k3s/
│           ├── control-1/
│           ├── control-2/
│           └── control-3/
├── modules/
│   ├── shared/           # shared by all hosts
│   ├── lxc/             # lxc-specific modules
│   └── vms/             # vm-specific modules
├── secrets/
│   ├── generated/        # generated by agenix-rekey
│   └── rekeyed/         # rekeyed secrets (gitignored)
└── images/              # base images (iso, lxc templates)
```

## fileserver (samba)

the fileserver lxc container provides secure samba shares with automatic user and share management.

### features

- **auto-generated users**: single list generates linux users, samba shares, and secrets
- **personal shares**: each user gets private share (not browseable by others)
- **shared folder**: `/shares/shared` accessible by all users
- **recycle bin**: per-user trash bin at `.recycle/%U` in each share
- **encryption**: smb3_11 with required encryption
- **secure defaults**: proper permissions, force user/group, valid users only
- **network access**: allows local networks (10/8, 172.16/12, 192.168/16) and tailscale (100.64/10)

### folder structure

```
/shares/
├── user1/          # user1's personal share
├── user2/          # user2's personal share
└── shared/         # shared by all users
```

this structure is technology-agnostic (no `/data/samba` coupling to implementation).

### adding a fileserver user

the user list is stored privately in your nixsecrets repo. edit `fileserver-users.nix` in your nixsecrets repo:

```nix
# nixsecrets/fileserver-users.nix
[ "user1" "user2" "newuser" ]
```

this automatically:

1. creates linux user with home in `/shares/newuser`
2. generates personal samba share
3. sets up password secrets (smb-pw-newuser, user-pw-newuser)

then add password secrets to your nixsecrets repo:

```bash
# in your nixsecrets repo
# add ragenix/infra/lxc.fileserver.newuser.pw.smb.age
# add ragenix/infra/lxc.fileserver.newuser.pw.hash.age
```

finally, rekey secrets:

```bash
agenix rekey -a
```

### samba configuration highlights

from `hosts/lxc/fileserver/samba.nix`:

```nix
# vfs objects for compatibility and features
"vfs objects" = "catia fruit streams_xattr recycle";

# per-user recycle bin
"recycle:repository" = ".recycle/%U";
"recycle:keeptree" = "yes";
"recycle:versions" = "yes";

# security
"server min protocol" = "SMB3_11";
"server smb encrypt" = "required";
"client ipc signing" = "mandatory";

# network access (local + tailscale)
"hosts allow" = "127.0.0.0/8 10.0.0.0/8 172.16/12 192.168/16 100.64/10";
```

personal shares are auto-generated using:

```nix
personalShares = lib.genAttrs sambaUsers mkPersonalShare;
```

## secrets management

using agenix-rekey for encrypted secrets with automatic host key management.

### structure

- secrets stored in external `nixsecrets` repository (git+ssh)
- each host defines `age.rekey.hostPubkey` for encryption
- secrets automatically rekeyed when host keys change
- gitignored `secrets/rekeyed/` contains decrypted secrets for local testing

### auto-generated secrets

fileserver demonstrates auto-generation pattern:

```nix
# from hosts/lxc/fileserver/secrets.nix
mkUserSecrets = user: {
  "smb-pw-${user}".rekeyFile =
    "${inputs.nixsecrets}/ragenix/infra/lxc.fileserver.${user}.pw.smb.age";
  "user-pw-${user}".rekeyFile =
    "${inputs.nixsecrets}/ragenix/infra/lxc.fileserver.${user}.pw.hash.age";
};

allSecrets = lib.foldl' (acc: user: acc // mkUserSecrets user) { } fileserverUsers;
```

this eliminates repetitive secret definitions - just maintain the user list.

### workflow

```bash
# after adding new secrets to nixsecrets repo
agenix rekey -a

# edit a secret
agenix edit secrets/rekeyed/fileserver/smb-pw-1.age
```

## development

### requirements

- nix with flakes enabled
- git or jujutsu (jj)
- agenix-rekey (available in dev shell)

### entering dev shell

```bash
nix develop
```

this provides:

- agenix-rekey for secret management
- pre-commit hooks (nixfmt, statix, deadnix)
- all required build dependencies

### terraform shell

for managing proxmox and hetzner infrastructure:

```bash
nix develop .#terraform
```

provides opentofu with proxmox and hcloud providers.

## building

### system configurations

```bash
# build specific host
nix build .#nixosConfigurations.fileserver-lxc.config.system.build.toplevel

# build all hosts (via checks)
nix flake check
```

### images

```bash
# lxc base image (proxmox template)
nix build .#lxc-base

# vm base image (iso)
nix build .#vm-base
```

## deployment

### using nh (recommended)

```bash
# deploy to system
nh os switch

# deploy home-manager
nh home switch
```

### manual deployment

```bash
# build and switch
nixos-rebuild switch --flake .#fileserver-lxc

# build only
nixos-rebuild build --flake .#fileserver-lxc
```

## conventions

- **lowercase everything**: except product names (NixOS, GitHub, Proxmox)
- **kiss principles**: simple, maintainable patterns over complex abstractions
- **dry**: single source of truth, auto-generate from it
- **newline at eof**: all files end with newline
- **formatting**: nixfmt-rfc-style (2-space indentation)

## checks and quality

pre-commit hooks enforce:

- **nixfmt-rfc-style**: consistent nix formatting
- **statix**: static analysis for nix code
- **deadnix**: detect unused nix code
- **treefmt**: format all file types

run manually:

```bash
nix flake check    # all checks
nix fmt           # format all files
```

## current hosts

generated from directory structure:

### lxc containers

- `fileserver-lxc`: samba fileserver
- `newt-lxc`: general purpose container
- `pangolin-lxc`: general purpose container
- `tailscale-lxc`: tailscale relay/subnet router

### bare-metal

- `home-server-bare-metal`: home server
- `proxmox-bare-metal`: proxmox host

### vms

- `control-1-vms`: k3s control plane node 1
- `control-2-vms`: k3s control plane node 2
- `control-3-vms`: k3s control plane node 3

## troubleshooting

### flake doesn't see new files

nix flakes only see git-tracked files:

```bash
git add path/to/new/file
```

### secrets not working

rekey after changes:

```bash
agenix rekey -a
```

### hostname conflicts

auto-generated hostnames use `lib.mkDefault` - you can override:

```nix
{ config, ... }:
{
  networking.hostName = "my-custom-name";  # overrides auto-generated
}
```

### check fails

run with verbose output:

```bash
nix flake check --show-trace
```

## references

- [NixOS Manual](https://nixos.org/manual/nixos/stable/)
- [Nix Flakes](https://nixos.wiki/wiki/Flakes)
- [agenix-rekey](https://github.com/oddlama/agenix-rekey)
- [nixos-generators](https://github.com/nix-community/nixos-generators)
